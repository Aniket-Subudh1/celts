import React, { useEffect, useState, useCallback } from 'react';\nimport { AlertTriangle, Shield, Wifi, WifiOff, Monitor, Clock, X } from 'lucide-react';\nimport { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Progress } from '@/components/ui/progress';\nimport { toast } from 'sonner';\nimport api from '@/lib/api';\n\ninterface ExamSecurityStatus {\n  securityStatus: string;\n  securityScore: number;\n  violations: number;\n  networkSecurity: {\n    isVPN: boolean;\n    isProxy: boolean;\n    disconnections: number;\n  };\n  browserSecurity: {\n    isSecure: boolean;\n    browser: string;\n  };\n  screenViolations: {\n    fullscreenExits: number;\n    tabSwitches: number;\n    windowBlurs: number;\n  };\n}\n\ninterface ExamSecurityPanelProps {\n  attemptId: string;\n  sessionToken: string;\n  onSecurityViolation?: (violation: string) => void;\n  onForceSubmit?: () => void;\n  showDetailedStatus?: boolean;\n}\n\nexport function ExamSecurityPanel({\n  attemptId,\n  sessionToken,\n  onSecurityViolation,\n  onForceSubmit,\n  showDetailedStatus = true\n}: ExamSecurityPanelProps) {\n  const [securityStatus, setSecurityStatus] = useState<ExamSecurityStatus | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [timeRemaining, setTimeRemaining] = useState<number | null>(null);\n  const [currentTime, setCurrentTime] = useState(new Date());\n  const [warnings, setWarnings] = useState<string[]>([]);\n\n  const fetchSecurityStatus = useCallback(async () => {\n    try {\n      const response = await api.apiGet(`/security/status/${attemptId}`);\n      setSecurityStatus(response.data || response);\n    } catch (error) {\n      console.error('Failed to fetch security status:', error);\n    }\n  }, [attemptId]);\n\n  const fetchTimeRemaining = useCallback(async () => {\n    try {\n      const response = await api.apiGet(`/security/timer/remaining/${attemptId}?type=exam`);\n      const data = response.data || response;\n      setTimeRemaining(data.remaining || 0);\n    } catch (error) {\n      console.error('Failed to fetch time remaining:', error);\n    }\n  }, [attemptId]);\n\n  // Initial data fetch\n  useEffect(() => {\n    const loadData = async () => {\n      setLoading(true);\n      await Promise.all([fetchSecurityStatus(), fetchTimeRemaining()]);\n      setLoading(false);\n    };\n    \n    loadData();\n  }, [fetchSecurityStatus, fetchTimeRemaining]);\n\n  // Periodic updates\n  useEffect(() => {\n    const interval = setInterval(() => {\n      fetchSecurityStatus();\n      fetchTimeRemaining();\n      setCurrentTime(new Date());\n    }, 10000); // Update every 10 seconds\n\n    return () => clearInterval(interval);\n  }, [fetchSecurityStatus, fetchTimeRemaining]);\n\n  // Timer countdown\n  useEffect(() => {\n    if (timeRemaining === null || timeRemaining <= 0) return;\n\n    const countdown = setInterval(() => {\n      setTimeRemaining(prev => {\n        if (prev === null || prev <= 1) {\n          clearInterval(countdown);\n          toast.error('Time Expired', {\n            description: 'Exam time has expired. Submitting automatically.',\n            duration: 5000,\n          });\n          onForceSubmit?.();\n          return 0;\n        }\n        return prev - 1;\n      });\n    }, 1000);\n\n    return () => clearInterval(countdown);\n  }, [timeRemaining, onForceSubmit]);\n\n  // Security score monitoring\n  useEffect(() => {\n    if (!securityStatus) return;\n\n    const newWarnings: string[] = [];\n\n    if (securityStatus.securityScore < 70) {\n      newWarnings.push('Security score is low due to violations');\n    }\n\n    if (securityStatus.networkSecurity.isVPN) {\n      newWarnings.push('VPN connection detected');\n    }\n\n    if (!securityStatus.browserSecurity.isSecure) {\n      newWarnings.push('Non-secure browser detected');\n    }\n\n    if (securityStatus.screenViolations.tabSwitches > 0) {\n      newWarnings.push(`${securityStatus.screenViolations.tabSwitches} tab switches detected`);\n    }\n\n    if (securityStatus.screenViolations.fullscreenExits > 0) {\n      newWarnings.push(`${securityStatus.screenViolations.fullscreenExits} fullscreen exits detected`);\n    }\n\n    setWarnings(newWarnings);\n\n    // Critical security check\n    if (securityStatus.securityScore < 50) {\n      toast.error('Critical Security Alert', {\n        description: 'Multiple violations detected. Exam may be terminated.',\n        duration: 8000,\n      });\n      onSecurityViolation?.('critical_score');\n    }\n  }, [securityStatus, onSecurityViolation]);\n\n  const getSecurityColor = (score: number) => {\n    if (score >= 90) return 'text-green-600';\n    if (score >= 70) return 'text-yellow-600';\n    if (score >= 50) return 'text-orange-600';\n    return 'text-red-600';\n  };\n\n  const getSecurityBadgeVariant = (score: number): 'default' | 'secondary' | 'destructive' | 'outline' => {\n    if (score >= 90) return 'default';\n    if (score >= 70) return 'secondary';\n    if (score >= 50) return 'outline';\n    return 'destructive';\n  };\n\n  const formatTime = (seconds: number): string => {\n    const hours = Math.floor(seconds / 3600);\n    const minutes = Math.floor((seconds % 3600) / 60);\n    const remainingSeconds = seconds % 60;\n\n    if (hours > 0) {\n      return `${hours}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;\n    }\n    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;\n  };\n\n  const dismissWarning = (index: number) => {\n    setWarnings(prev => prev.filter((_, i) => i !== index));\n  };\n\n  if (loading) {\n    return (\n      <div className=\"space-y-4\">\n        <div className=\"flex items-center space-x-2\">\n          <Shield className=\"w-4 h-4 animate-pulse\" />\n          <span className=\"text-sm text-gray-600\">Loading security status...</span>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Security Score and Timer */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n        {/* Security Score */}\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"flex items-center space-x-2 text-sm\">\n              <Shield className=\"w-4 h-4\" />\n              <span>Security Score</span>\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center justify-between\">\n                <span className={`text-2xl font-bold ${getSecurityColor(securityStatus?.securityScore || 0)}`}>\n                  {securityStatus?.securityScore || 0}\n                </span>\n                <Badge variant={getSecurityBadgeVariant(securityStatus?.securityScore || 0)}>\n                  {securityStatus?.securityStatus || 'Unknown'}\n                </Badge>\n              </div>\n              <Progress \n                value={securityStatus?.securityScore || 0} \n                className=\"w-full\" \n              />\n              <p className=\"text-xs text-gray-600\">\n                {securityStatus?.violations || 0} violations detected\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Timer */}\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"flex items-center space-x-2 text-sm\">\n              <Clock className=\"w-4 h-4\" />\n              <span>Time Remaining</span>\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2\">\n              <div className=\"text-2xl font-bold text-blue-600\">\n                {timeRemaining !== null ? formatTime(timeRemaining) : '--:--'}\n              </div>\n              <p className=\"text-xs text-gray-600\">\n                Current time: {currentTime.toLocaleTimeString()}\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Security Warnings */}\n      {warnings.length > 0 && (\n        <div className=\"space-y-2\">\n          {warnings.map((warning, index) => (\n            <Alert key={index} variant=\"destructive\">\n              <AlertTriangle className=\"h-4 w-4\" />\n              <AlertTitle>Security Warning</AlertTitle>\n              <AlertDescription className=\"flex items-center justify-between\">\n                <span>{warning}</span>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => dismissWarning(index)}\n                  className=\"ml-2 h-6 w-6 p-0\"\n                >\n                  <X className=\"h-4 w-4\" />\n                </Button>\n              </AlertDescription>\n            </Alert>\n          ))}\n        </div>\n      )}\n\n      {/* Detailed Status (optional) */}\n      {showDetailedStatus && securityStatus && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-sm\">Security Details</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {/* Network Security */}\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center space-x-2\">\n                {securityStatus.networkSecurity.disconnections > 0 ? (\n                  <WifiOff className=\"w-4 h-4 text-red-500\" />\n                ) : (\n                  <Wifi className=\"w-4 h-4 text-green-500\" />\n                )}\n                <span className=\"text-sm\">Network</span>\n              </div>\n              <div className=\"text-right text-sm\">\n                {securityStatus.networkSecurity.isVPN && (\n                  <Badge variant=\"destructive\" className=\"text-xs\">VPN</Badge>\n                )}\n                {securityStatus.networkSecurity.disconnections > 0 && (\n                  <span className=\"text-red-600 ml-2\">\n                    {securityStatus.networkSecurity.disconnections} disconnections\n                  </span>\n                )}\n              </div>\n            </div>\n\n            {/* Browser Security */}\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center space-x-2\">\n                <Monitor className=\"w-4 h-4\" />\n                <span className=\"text-sm\">Browser</span>\n              </div>\n              <div className=\"text-right text-sm\">\n                <span className={securityStatus.browserSecurity.isSecure ? 'text-green-600' : 'text-red-600'}>\n                  {securityStatus.browserSecurity.browser}\n                </span>\n                {!securityStatus.browserSecurity.isSecure && (\n                  <Badge variant=\"destructive\" className=\"text-xs ml-2\">Insecure</Badge>\n                )}\n              </div>\n            </div>\n\n            {/* Screen Violations */}\n            <div className=\"space-y-1\">\n              <div className=\"text-sm font-medium\">Screen Violations</div>\n              <div className=\"grid grid-cols-3 gap-2 text-xs\">\n                <div className=\"text-center\">\n                  <div className=\"font-medium\">{securityStatus.screenViolations.tabSwitches}</div>\n                  <div className=\"text-gray-600\">Tab Switches</div>\n                </div>\n                <div className=\"text-center\">\n                  <div className=\"font-medium\">{securityStatus.screenViolations.fullscreenExits}</div>\n                  <div className=\"text-gray-600\">Fullscreen Exits</div>\n                </div>\n                <div className=\"text-center\">\n                  <div className=\"font-medium\">{securityStatus.screenViolations.windowBlurs}</div>\n                  <div className=\"text-gray-600\">Focus Loss</div>\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n\nexport default ExamSecurityPanel;